import{r as l,j as a,T as Ce,B as F,l as ke,a as W,F as q}from"./index-DfR4J3qm.js";import{G as ne}from"./index-DA2yu6bt.js";var ae=Symbol.for("immer-nothing"),ie=Symbol.for("immer-draftable"),_=Symbol.for("immer-state");function p(e,...r){throw new Error(`[Immer] minified error nr: ${e}. Full error at: https://bit.ly/3cXEKWf`)}var O=Object.getPrototypeOf;function A(e){return!!e&&!!e[_]}function S(e){return e?le(e)||Array.isArray(e)||!!e[ie]||!!e.constructor?.[ie]||E(e)||K(e):!1}var we=Object.prototype.constructor.toString();function le(e){if(!e||typeof e!="object")return!1;const r=O(e);if(r===null)return!0;const t=Object.hasOwnProperty.call(r,"constructor")&&r.constructor;return t===Object?!0:typeof t=="function"&&Function.toString.call(t)===we}function M(e,r){H(e)===0?Reflect.ownKeys(e).forEach(t=>{r(t,e[t],e)}):e.forEach((t,n)=>r(n,t,e))}function H(e){const r=e[_];return r?r.type_:Array.isArray(e)?1:E(e)?2:K(e)?3:0}function $(e,r){return H(e)===2?e.has(r):Object.prototype.hasOwnProperty.call(e,r)}function de(e,r,t){const n=H(e);n===2?e.set(r,t):n===3?e.add(t):e[r]=t}function ze(e,r){return e===r?e!==0||1/e===1/r:e!==e&&r!==r}function E(e){return e instanceof Map}function K(e){return e instanceof Set}function b(e){return e.copy_||e.base_}function L(e,r){if(E(e))return new Map(e);if(K(e))return new Set(e);if(Array.isArray(e))return Array.prototype.slice.call(e);const t=le(e);if(r===!0||r==="class_only"&&!t){const n=Object.getOwnPropertyDescriptors(e);delete n[_];let i=Reflect.ownKeys(n);for(let c=0;c<i.length;c++){const f=i[c],u=n[f];u.writable===!1&&(u.writable=!0,u.configurable=!0),(u.get||u.set)&&(n[f]={configurable:!0,writable:!0,enumerable:u.enumerable,value:e[f]})}return Object.create(O(e),n)}else{const n=O(e);if(n!==null&&t)return{...e};const i=Object.create(n);return Object.assign(i,e)}}function re(e,r=!1){return G(e)||A(e)||!S(e)||(H(e)>1&&Object.defineProperties(e,{set:{value:B},add:{value:B},clear:{value:B},delete:{value:B}}),Object.freeze(e),r&&Object.values(e).forEach(t=>re(t,!0))),e}function B(){p(2)}function G(e){return Object.isFrozen(e)}var Oe={};function x(e){const r=Oe[e];return r||p(0,e),r}var v;function ye(){return v}function Ae(e,r){return{drafts_:[],parent_:e,immer_:r,canAutoFreeze_:!0,unfinalizedDrafts_:0}}function oe(e,r){r&&(x("Patches"),e.patches_=[],e.inversePatches_=[],e.patchListener_=r)}function Q(e){Y(e),e.drafts_.forEach(Fe),e.drafts_=null}function Y(e){e===v&&(v=e.parent_)}function se(e){return v=Ae(v,e)}function Fe(e){const r=e[_];r.type_===0||r.type_===1?r.revoke_():r.revoked_=!0}function ce(e,r){r.unfinalizedDrafts_=r.drafts_.length;const t=r.drafts_[0];return e!==void 0&&e!==t?(t[_].modified_&&(Q(r),p(4)),S(e)&&(e=U(r,e),r.parent_||J(r,e)),r.patches_&&x("Patches").generateReplacementPatches_(t[_].base_,e,r.patches_,r.inversePatches_)):e=U(r,t,[]),Q(r),r.patches_&&r.patchListener_(r.patches_,r.inversePatches_),e!==ae?e:void 0}function U(e,r,t){if(G(r))return r;const n=r[_];if(!n)return M(r,(i,c)=>fe(e,n,r,i,c,t)),r;if(n.scope_!==e)return r;if(!n.modified_)return J(e,n.base_,!0),n.base_;if(!n.finalized_){n.finalized_=!0,n.scope_.unfinalizedDrafts_--;const i=n.copy_;let c=i,f=!1;n.type_===3&&(c=new Set(i),i.clear(),f=!0),M(c,(u,m)=>fe(e,n,i,u,m,t,f)),J(e,i,!1),t&&e.patches_&&x("Patches").generatePatches_(n,t,e.patches_,e.inversePatches_)}return n.copy_}function fe(e,r,t,n,i,c,f){if(A(i)){const u=c&&r&&r.type_!==3&&!$(r.assigned_,n)?c.concat(n):void 0,m=U(e,i,u);if(de(t,n,m),A(m))e.canAutoFreeze_=!1;else return}else f&&t.add(i);if(S(i)&&!G(i)){if(!e.immer_.autoFreeze_&&e.unfinalizedDrafts_<1)return;U(e,i),(!r||!r.scope_.parent_)&&typeof n!="symbol"&&(E(t)?t.has(n):Object.prototype.propertyIsEnumerable.call(t,n))&&J(e,i)}}function J(e,r,t=!1){!e.parent_&&e.immer_.autoFreeze_&&e.canAutoFreeze_&&re(r,t)}function ve(e,r){const t=Array.isArray(e),n={type_:t?1:0,scope_:r?r.scope_:ye(),modified_:!1,finalized_:!1,assigned_:{},parent_:r,base_:e,draft_:null,copy_:null,revoke_:null,isManual_:!1};let i=n,c=te;t&&(i=[n],c=R);const{revoke:f,proxy:u}=Proxy.revocable(i,c);return n.draft_=u,n.revoke_=f,u}var te={get(e,r){if(r===_)return e;const t=b(e);if(!$(t,r))return Re(e,t,r);const n=t[r];return e.finalized_||!S(n)?n:n===X(e.base_,r)?(Z(e),e.copy_[r]=ee(n,e)):n},has(e,r){return r in b(e)},ownKeys(e){return Reflect.ownKeys(b(e))},set(e,r,t){const n=_e(b(e),r);if(n?.set)return n.set.call(e.draft_,t),!0;if(!e.modified_){const i=X(b(e),r),c=i?.[_];if(c&&c.base_===t)return e.copy_[r]=t,e.assigned_[r]=!1,!0;if(ze(t,i)&&(t!==void 0||$(e.base_,r)))return!0;Z(e),V(e)}return e.copy_[r]===t&&(t!==void 0||r in e.copy_)||Number.isNaN(t)&&Number.isNaN(e.copy_[r])||(e.copy_[r]=t,e.assigned_[r]=!0),!0},deleteProperty(e,r){return X(e.base_,r)!==void 0||r in e.base_?(e.assigned_[r]=!1,Z(e),V(e)):delete e.assigned_[r],e.copy_&&delete e.copy_[r],!0},getOwnPropertyDescriptor(e,r){const t=b(e),n=Reflect.getOwnPropertyDescriptor(t,r);return n&&{writable:!0,configurable:e.type_!==1||r!=="length",enumerable:n.enumerable,value:t[r]}},defineProperty(){p(11)},getPrototypeOf(e){return O(e.base_)},setPrototypeOf(){p(12)}},R={};M(te,(e,r)=>{R[e]=function(){return arguments[0]=arguments[0][0],r.apply(this,arguments)}});R.deleteProperty=function(e,r){return R.set.call(this,e,r,void 0)};R.set=function(e,r,t){return te.set.call(this,e[0],r,t,e[0])};function X(e,r){const t=e[_];return(t?b(t):e)[r]}function Re(e,r,t){const n=_e(r,t);return n?"value"in n?n.value:n.get?.call(e.draft_):void 0}function _e(e,r){if(!(r in e))return;let t=O(e);for(;t;){const n=Object.getOwnPropertyDescriptor(t,r);if(n)return n;t=O(t)}}function V(e){e.modified_||(e.modified_=!0,e.parent_&&V(e.parent_))}function Z(e){e.copy_||(e.copy_=L(e.base_,e.scope_.immer_.useStrictShallowCopy_))}var Ee=class{constructor(e){this.autoFreeze_=!0,this.useStrictShallowCopy_=!1,this.produce=(r,t,n)=>{if(typeof r=="function"&&typeof t!="function"){const c=t;t=r;const f=this;return function(m=c,...j){return f.produce(m,T=>t.call(this,T,...j))}}typeof t!="function"&&p(6),n!==void 0&&typeof n!="function"&&p(7);let i;if(S(r)){const c=se(this),f=ee(r,void 0);let u=!0;try{i=t(f),u=!1}finally{u?Q(c):Y(c)}return oe(c,n),ce(i,c)}else if(!r||typeof r!="object"){if(i=t(r),i===void 0&&(i=r),i===ae&&(i=void 0),this.autoFreeze_&&re(i,!0),n){const c=[],f=[];x("Patches").generateReplacementPatches_(r,i,c,f),n(c,f)}return i}else p(1,r)},this.produceWithPatches=(r,t)=>{if(typeof r=="function")return(f,...u)=>this.produceWithPatches(f,m=>r(m,...u));let n,i;return[this.produce(r,t,(f,u)=>{n=f,i=u}),n,i]},typeof e?.autoFreeze=="boolean"&&this.setAutoFreeze(e.autoFreeze),typeof e?.useStrictShallowCopy=="boolean"&&this.setUseStrictShallowCopy(e.useStrictShallowCopy)}createDraft(e){S(e)||p(8),A(e)&&(e=Te(e));const r=se(this),t=ee(e,void 0);return t[_].isManual_=!0,Y(r),t}finishDraft(e,r){const t=e&&e[_];(!t||!t.isManual_)&&p(9);const{scope_:n}=t;return oe(n,r),ce(void 0,n)}setAutoFreeze(e){this.autoFreeze_=e}setUseStrictShallowCopy(e){this.useStrictShallowCopy_=e}applyPatches(e,r){let t;for(t=r.length-1;t>=0;t--){const i=r[t];if(i.path.length===0&&i.op==="replace"){e=i.value;break}}t>-1&&(r=r.slice(t+1));const n=x("Patches").applyPatches_;return A(e)?n(e,r):this.produce(e,i=>n(i,r))}};function ee(e,r){const t=E(e)?x("MapSet").proxyMap_(e,r):K(e)?x("MapSet").proxySet_(e,r):ve(e,r);return(r?r.scope_:ye()).drafts_.push(t),t}function Te(e){return A(e)||p(10,e),he(e)}function he(e){if(!S(e)||G(e))return e;const r=e[_];let t;if(r){if(!r.modified_)return r.base_;r.finalized_=!0,t=L(e,r.scope_.immer_.useStrictShallowCopy_)}else t=L(e,!0);return M(t,(n,i)=>{de(t,n,he(i))}),r&&(r.finalized_=!1),t}var Ne=new Ee,ue=Ne.produce;function Ie(e,r){const{mapper:t,historyLimit:n=50,enableHistory:i=!0,valueDedup:c=!0}=r||{},f=l.useRef(t?.toDraft),u=l.useRef(t?.fromDraft);f.current=t?.toDraft,u.current=t?.fromDraft;const m=f.current?f.current(e):e,[j,T]=l.useState(e),[C,k]=l.useState(m),D=l.useRef(i?[m]:[]),h=l.useRef(i?0:-1);l.useEffect(()=>{T(e);const s=f.current?f.current(e):e;k(s),i&&(D.current=[s],h.current=0)},[e,i]);const N=l.useCallback((s,o)=>{if(s===o)return!0;if(s instanceof Date&&o instanceof Date)return s.getTime()===o.getTime();if(s instanceof Date||o instanceof Date)return!1;if(typeof s!="object"||typeof o!="object"||s==null||o==null)return s===o;if(Array.isArray(s)||Array.isArray(o)){if(!Array.isArray(s)||!Array.isArray(o)||s.length!==o.length)return!1;for(let g=0;g<s.length;g++)if(!N(s[g],o[g]))return!1;return!0}const d=Object.keys(s),y=Object.keys(o);if(d.length!==y.length)return!1;for(const g of d)if(!Object.prototype.hasOwnProperty.call(o,g)||!N(s[g],o[g]))return!1;return!0},[]),I=l.useCallback(s=>{if(!i)return;const o=D.current,d=h.current;d<o.length-1&&o.splice(d+1);const y=o.length?o[o.length-1]:void 0;if(y===s){h.current=o.length-1;return}if(c&&y!==void 0&&N(y,s)){h.current=o.length-1;return}o.push(s),o.length>n&&o.shift(),h.current=o.length-1},[i,n,c,N]),me=l.useCallback(s=>{k(o=>{const d=ue(o,y=>{Object.assign(y,s)});return d===o?o:(I(d),d)})},[I]),pe=l.useCallback((s,o)=>{k(d=>{const y=ue(d,g=>{const P=s.split(".").filter(Boolean);let w=g;for(let z=0;z<P.length-1;z++)(!w[P[z]]||typeof w[P[z]]!="object")&&(w[P[z]]={}),w=w[P[z]];w[P[P.length-1]]=o});return y===d?d:(I(y),y)})},[I]),ge=l.useCallback(s=>{const o=s.split(".").filter(Boolean);let d=C;for(const y of o){if(d==null)return;d=d[y]}return d},[C]),De=l.useCallback(()=>{const s=f.current?f.current(j):j;k(s),i&&(D.current=[s],h.current=0)},[j,i]),Pe=l.useCallback(()=>{i&&h.current>0&&(h.current-=1,k(D.current[h.current]))},[i]),be=i&&h.current>0,Se=l.useCallback(s=>{T(s);const o=f.current?f.current(s):s;k(o),i&&(D.current=[o],h.current=0)},[i]),xe=l.useCallback(()=>u.current?u.current(C):C,[C]),je=l.useCallback(()=>{try{return JSON.parse(JSON.stringify(D.current))}catch{return D.current.map(s=>({...s}))}},[]);return{original:j,draft:C,set:me,setAt:pe,getAt:ge,rollback:De,undo:Pe,canUndo:be,onServerResponse200:Se,commit:xe,_historyForDebug:je}}const Be={toDraft:e=>({id:e.id,name:e.name,birthDate:e.birthDate?new Date(e.birthDate):null,city:e.address?.city??"",zip:e.address?.zip??""}),fromDraft:e=>({id:e.id,name:e.name,birthDate:e.birthDate?e.birthDate.toISOString():"",address:{city:e.city,zip:e.zip}})},Me={id:1,name:"Alice",birthDate:"2022-05-11T12:00:00.000Z",address:{city:"Paris",zip:"75000"}};function He(){const e=Ie(Me,{mapper:Be}),[r,t]=l.useState(e.draft.name);return l.useEffect(()=>{t(e.draft.name)},[e.draft.name]),a.jsxs(a.Fragment,{children:[a.jsxs(ne,{gridTemplateColumns:{xs:"1fr",sm:"1fr 140px"},dangerous:{alignItems:"end",alignContent:"end"},gap:{xs:"var(--gap-4)"},children:[a.jsx(Ce,{id:"test-editor",label:"name",value:r,onChange:n=>t(n),onBlur:()=>e.set({name:r}),placeholder:"Type name and blur (or press Set Name)"}),a.jsx(F,{onClick:()=>e.set({name:r}),children:"Set Name"})]}),a.jsx("br",{}),a.jsxs(ke,{label:"Operate",dangerous:{gap:"var(--gap-2)"},children:[a.jsx(F,{onClick:()=>e.setAt("birthDate",new Date),children:"Set date (now)"}),a.jsx(F,{onClick:()=>e.undo(),disabled:!e.canUndo,children:"Undo"}),a.jsx(F,{onClick:()=>e.rollback(),children:"Rollback (reset to original)"}),a.jsx(F,{onClick:()=>{const n=e.commit();console.log("commit payload:",n),e.onServerResponse200(n)},children:"Commit (simulate server)"})]}),a.jsx("br",{}),a.jsxs(ne,{gridTemplateColumns:{xs:"1fr",md:"1fr 1fr"},gap:{xs:"var(--gap-4)"},children:[a.jsxs(W,{mood:"positive",children:[a.jsx(q.Bold,{children:"Draft:"}),a.jsx("pre",{children:JSON.stringify(e.draft,(n,i)=>i instanceof Date?i.toISOString():i,2)})]}),a.jsxs(W,{children:[a.jsx(q.Bold,{children:"Original (server):"}),a.jsx("pre",{children:JSON.stringify(e.original,null,2)})]})]}),a.jsx("br",{}),a.jsxs(W,{mood:"negative",children:[a.jsx(q.Bold,{children:"History (safe debug):"}),a.jsx("pre",{children:JSON.stringify(e._historyForDebug(),null,2)})]}),a.jsx("br",{})]})}export{He as default};
