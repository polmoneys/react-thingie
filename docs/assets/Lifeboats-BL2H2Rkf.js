import{e as U,r as h,j as a,l as _,B as g,I as k,a as F,F as O}from"./index-DsIyf4BL.js";import{G as J}from"./index-0T_6LqEM.js";import{u as G}from"./useQuery-CAyAH-I6.js";import{u as p}from"./useMutation-B3rRlARB.js";const M=(e,t)=>t.some(n=>e instanceof n);let T,N;function Y(){return T||(T=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function z(){return N||(N=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const A=new WeakMap,v=new WeakMap,C=new WeakMap;function X(e){const t=new Promise((n,r)=>{const i=()=>{e.removeEventListener("success",c),e.removeEventListener("error",s)},c=()=>{n(y(e.result)),i()},s=()=>{r(e.error),i()};e.addEventListener("success",c),e.addEventListener("error",s)});return C.set(t,e),t}function $(e){if(A.has(e))return;const t=new Promise((n,r)=>{const i=()=>{e.removeEventListener("complete",c),e.removeEventListener("error",s),e.removeEventListener("abort",s)},c=()=>{n(),i()},s=()=>{r(e.error||new DOMException("AbortError","AbortError")),i()};e.addEventListener("complete",c),e.addEventListener("error",s),e.addEventListener("abort",s)});A.set(e,t)}let E={get(e,t,n){if(e instanceof IDBTransaction){if(t==="done")return A.get(e);if(t==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return y(e[t])},set(e,t,n){return e[t]=n,!0},has(e,t){return e instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in e}};function R(e){E=e(E)}function H(e){return z().includes(e)?function(...t){return e.apply(P(this),t),y(this.request)}:function(...t){return y(e.apply(P(this),t))}}function Z(e){return typeof e=="function"?H(e):(e instanceof IDBTransaction&&$(e),M(e,Y())?new Proxy(e,E):e)}function y(e){if(e instanceof IDBRequest)return X(e);if(v.has(e))return v.get(e);const t=Z(e);return t!==e&&(v.set(e,t),C.set(t,e)),t}const P=e=>C.get(e);function ee(e,t,{blocked:n,upgrade:r,blocking:i,terminated:c}={}){const s=indexedDB.open(e,t),l=y(s);return r&&s.addEventListener("upgradeneeded",o=>{r(y(s.result),o.oldVersion,o.newVersion,y(s.transaction),o)}),n&&s.addEventListener("blocked",o=>n(o.oldVersion,o.newVersion,o)),l.then(o=>{c&&o.addEventListener("close",()=>c()),i&&o.addEventListener("versionchange",d=>i(d.oldVersion,d.newVersion,d))}).catch(()=>{}),l}const te=["get","getKey","getAll","getAllKeys","count"],ne=["put","add","delete","clear"],L=new Map;function K(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&typeof t=="string"))return;if(L.get(t))return L.get(t);const n=t.replace(/FromIndex$/,""),r=t!==n,i=ne.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!(i||te.includes(n)))return;const c=async function(s,...l){const o=this.transaction(s,i?"readwrite":"readonly");let d=o.store;return r&&(d=d.index(l.shift())),(await Promise.all([d[n](...l),i&&o.done]))[0]};return L.set(t,c),c}R(e=>({...e,get:(t,n,r)=>K(t,n)||e.get(t,n,r),has:(t,n)=>!!K(t,n)||e.has(t,n)}));const re=["continue","continuePrimaryKey","advance"],V={},S=new WeakMap,W=new WeakMap,se={get(e,t){if(!re.includes(t))return e[t];let n=V[t];return n||(n=V[t]=function(...r){S.set(this,W.get(this)[t](...r))}),n}};async function*ae(...e){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...e)),!t)return;t=t;const n=new Proxy(t,se);for(W.set(n,t),C.set(n,P(t));t;)yield n,t=await(S.get(n)||t.continue()),S.delete(n)}function Q(e,t){return t===Symbol.asyncIterator&&M(e,[IDBIndex,IDBObjectStore,IDBCursor])||t==="iterate"&&M(e,[IDBIndex,IDBObjectStore])}R(e=>({...e,get(t,n,r){return Q(t,n)?ae:e.get(t,n,r)},has(t,n){return Q(t,n)||e.has(t,n)}}));const ie="lifeboats-db",m="lifeboats",oe=24;let D=null;async function b(){return D||(D=await ee(ie,1,{upgrade(e){e.objectStoreNames.contains(m)||e.createObjectStore(m,{keyPath:"key"}).createIndex("by-timestamp","timestamp")}}),D)}async function q(){return(await b()).getAll(m)}async function ce(e){return(await b()).get(m,e)}async function ue(e,t,n=!1){const r=await b(),i=await q();if(i.length>=oe){const s=i.filter(l=>!l.critical).sort((l,o)=>l.timestamp-o.timestamp);s.length>0&&await r.delete(m,s[0].key)}const c={timestamp:Date.now(),key:e,value:t,critical:n};return await r.put(m,c),c}async function le(e,t){const n=await b(),r=await ce(e),i={timestamp:Date.now(),key:e,value:t,critical:r?.critical??!1};return await n.put(m,i),i}async function de(e){await(await b()).delete(m,e)}async function fe(){const t=(await b()).transaction(m,"readwrite");await t.store.clear(),await t.done}const w=["lifeboats"];function me(){const e=U(),{data:t=[],isLoading:n,error:r}=G({queryKey:w,queryFn:q}),i=h.useCallback(u=>t.find(f=>f.key===u),[t]),c=p({mutationFn:({key:u,value:f,critical:B=!1})=>ue(u,f,B),onSuccess:()=>{e.invalidateQueries({queryKey:w})}}),s=p({mutationFn:({key:u,value:f})=>le(u,f),onSuccess:()=>{e.invalidateQueries({queryKey:w})}}),l=p({mutationFn:u=>de(u),onSuccess:()=>{e.invalidateQueries({queryKey:w})}}),o=p({mutationFn:fe,onSuccess:()=>{e.invalidateQueries({queryKey:w})}}),d=h.useCallback((u,f,B=!1)=>c.mutateAsync({key:u,value:f,critical:B}),[c]),x=h.useCallback((u,f)=>s.mutateAsync({key:u,value:f}),[s]),I=h.useCallback(u=>l.mutateAsync(u),[l]),j=h.useCallback(()=>o.mutateAsync(),[o]);return{lifeboats:t,isLoading:n,error:r,getLifeboat:i,create:d,update:x,remove:I,removeAll:j,isCreating:c.isPending,isUpdating:s.isPending,isDeleting:l.isPending,isDeletingAll:o.isPending}}function we(){const{getLifeboat:e,create:t,update:n,remove:r,removeAll:i,isCreating:c}=me(),s=async()=>{await t("critical-data","Critical value",!0)},l=async()=>{await t("draft-1",JSON.stringify({title:"My draft title",content:"Some text"}))},o=async()=>{await n("draft-1",JSON.stringify({title:"Updated draft title",content:"New text"}))},d=e("draft-1"),x=d?JSON.parse(d.value):null,I=async()=>{await i()},j=async()=>{await r("draft-1")},u=e("critical-data");return a.jsxs(a.Fragment,{children:[a.jsxs(_,{label:"Manage lifeboats",dangerous:{gap:"var(--gap-2)",flexWrap:"wrap"},children:[a.jsx(g.Positive,{onClick:l,children:"Create Draft"}),a.jsx(g.Positive,{onClick:o,children:"Update Draft"}),a.jsx(g.Negative,{isIcon:!0,onClick:j,children:"Clear Draft"}),a.jsx(g.Negative,{isIcon:!0,onClick:I,children:"Clear All"}),a.jsx(g.Positive,{onClick:s,disabled:u!==void 0,children:u===void 0?"Set critical info":a.jsx(k.Info,{size:28})})]}),a.jsx("br",{}),a.jsxs(J,{gridTemplateColumns:{xs:"1fr",md:"1fr 1fr"},gap:{xs:"var(--gap-4)"},children:[x!=null&&a.jsx(a.Fragment,{children:a.jsx(F,{mood:"positive",fitContent:!0,children:a.jsx(O,{children:x.title})})}),u!==void 0&&a.jsxs(a.Fragment,{children:[a.jsx("br",{}),a.jsx(F,{fitContent:!0,children:a.jsx(O,{children:typeof u?.value=="string"?u.value:""})})]})]}),c&&a.jsxs(a.Fragment,{children:[a.jsx("br",{}),a.jsx(k.LoadingBar,{})]})]})}export{we as default};
