import{f as U,r as h,j as r,l as _,B as g,I as k,a as F,F as O}from"./index-ClxU07Z-.js";import{G as J}from"./index-Brwx-FCl.js";import{u as G}from"./useQuery-0uoPIhpS.js";import{u as p}from"./useMutation-BP4fyA1P.js";const M=(e,t)=>t.some(n=>e instanceof n);let T,N;function Y(){return T||(T=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function z(){return N||(N=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const A=new WeakMap,v=new WeakMap,C=new WeakMap;function X(e){const t=new Promise((n,s)=>{const i=()=>{e.removeEventListener("success",c),e.removeEventListener("error",a)},c=()=>{n(y(e.result)),i()},a=()=>{s(e.error),i()};e.addEventListener("success",c),e.addEventListener("error",a)});return C.set(t,e),t}function $(e){if(A.has(e))return;const t=new Promise((n,s)=>{const i=()=>{e.removeEventListener("complete",c),e.removeEventListener("error",a),e.removeEventListener("abort",a)},c=()=>{n(),i()},a=()=>{s(e.error||new DOMException("AbortError","AbortError")),i()};e.addEventListener("complete",c),e.addEventListener("error",a),e.addEventListener("abort",a)});A.set(e,t)}let E={get(e,t,n){if(e instanceof IDBTransaction){if(t==="done")return A.get(e);if(t==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return y(e[t])},set(e,t,n){return e[t]=n,!0},has(e,t){return e instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in e}};function R(e){E=e(E)}function H(e){return z().includes(e)?function(...t){return e.apply(P(this),t),y(this.request)}:function(...t){return y(e.apply(P(this),t))}}function Z(e){return typeof e=="function"?H(e):(e instanceof IDBTransaction&&$(e),M(e,Y())?new Proxy(e,E):e)}function y(e){if(e instanceof IDBRequest)return X(e);if(v.has(e))return v.get(e);const t=Z(e);return t!==e&&(v.set(e,t),C.set(t,e)),t}const P=e=>C.get(e);function ee(e,t,{blocked:n,upgrade:s,blocking:i,terminated:c}={}){const a=indexedDB.open(e,t),l=y(a);return s&&a.addEventListener("upgradeneeded",o=>{s(y(a.result),o.oldVersion,o.newVersion,y(a.transaction),o)}),n&&a.addEventListener("blocked",o=>n(o.oldVersion,o.newVersion,o)),l.then(o=>{c&&o.addEventListener("close",()=>c()),i&&o.addEventListener("versionchange",d=>i(d.oldVersion,d.newVersion,d))}).catch(()=>{}),l}const te=["get","getKey","getAll","getAllKeys","count"],ne=["put","add","delete","clear"],L=new Map;function K(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&typeof t=="string"))return;if(L.get(t))return L.get(t);const n=t.replace(/FromIndex$/,""),s=t!==n,i=ne.includes(n);if(!(n in(s?IDBIndex:IDBObjectStore).prototype)||!(i||te.includes(n)))return;const c=async function(a,...l){const o=this.transaction(a,i?"readwrite":"readonly");let d=o.store;return s&&(d=d.index(l.shift())),(await Promise.all([d[n](...l),i&&o.done]))[0]};return L.set(t,c),c}R(e=>({...e,get:(t,n,s)=>K(t,n)||e.get(t,n,s),has:(t,n)=>!!K(t,n)||e.has(t,n)}));const re=["continue","continuePrimaryKey","advance"],V={},S=new WeakMap,W=new WeakMap,se={get(e,t){if(!re.includes(t))return e[t];let n=V[t];return n||(n=V[t]=function(...s){S.set(this,W.get(this)[t](...s))}),n}};async function*ae(...e){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...e)),!t)return;t=t;const n=new Proxy(t,se);for(W.set(n,t),C.set(n,P(t));t;)yield n,t=await(S.get(n)||t.continue()),S.delete(n)}function Q(e,t){return t===Symbol.asyncIterator&&M(e,[IDBIndex,IDBObjectStore,IDBCursor])||t==="iterate"&&M(e,[IDBIndex,IDBObjectStore])}R(e=>({...e,get(t,n,s){return Q(t,n)?ae:e.get(t,n,s)},has(t,n){return Q(t,n)||e.has(t,n)}}));const ie="lifeboats-db",m="lifeboats",oe=24;let D=null;async function b(){return D||(D=await ee(ie,1,{upgrade(e){e.objectStoreNames.contains(m)||e.createObjectStore(m,{keyPath:"key"}).createIndex("by-timestamp","timestamp")}}),D)}async function q(){return(await b()).getAll(m)}async function ce(e){return(await b()).get(m,e)}async function ue(e,t,n=!1){const s=await b(),i=await q();if(i.length>=oe){const a=i.filter(l=>!l.critical).sort((l,o)=>l.timestamp-o.timestamp);a.length>0&&await s.delete(m,a[0].key)}const c={timestamp:Date.now(),key:e,value:t,critical:n};return await s.put(m,c),c}async function le(e,t){const n=await b(),s=await ce(e),i={timestamp:Date.now(),key:e,value:t,critical:s?.critical??!1};return await n.put(m,i),i}async function de(e){await(await b()).delete(m,e)}async function fe(){const t=(await b()).transaction(m,"readwrite");await t.store.clear(),await t.done}const w=["lifeboats"];function me(){const e=U(),{data:t=[],isLoading:n,error:s}=G({queryKey:w,queryFn:q}),i=h.useCallback(u=>t.find(f=>f.key===u),[t]),c=p({mutationFn:({key:u,value:f,critical:B=!1})=>ue(u,f,B),onSuccess:()=>{e.invalidateQueries({queryKey:w})}}),a=p({mutationFn:({key:u,value:f})=>le(u,f),onSuccess:()=>{e.invalidateQueries({queryKey:w})}}),l=p({mutationFn:u=>de(u),onSuccess:()=>{e.invalidateQueries({queryKey:w})}}),o=p({mutationFn:fe,onSuccess:()=>{e.invalidateQueries({queryKey:w})}}),d=h.useCallback((u,f,B=!1)=>c.mutateAsync({key:u,value:f,critical:B}),[c]),x=h.useCallback((u,f)=>a.mutateAsync({key:u,value:f}),[a]),I=h.useCallback(u=>l.mutateAsync(u),[l]),j=h.useCallback(()=>o.mutateAsync(),[o]);return{lifeboats:t,isLoading:n,error:s,getLifeboat:i,create:d,update:x,remove:I,removeAll:j,isCreating:c.isPending,isUpdating:a.isPending,isDeleting:l.isPending,isDeletingAll:o.isPending}}function we(){const{getLifeboat:e,create:t,update:n,remove:s,removeAll:i,isCreating:c}=me(),a=async()=>{await t("critical-data","Critical value",!0)},l=async()=>{await t("draft-1",JSON.stringify({title:"My draft title",content:"Some text"}))},o=async()=>{await n("draft-1",JSON.stringify({title:"Updated draft title",content:"New text"}))},d=e("draft-1"),x=d?JSON.parse(d.value):null,I=async()=>{await i()},j=async()=>{await s("draft-1")},u=e("critical-data");return r.jsxs(r.Fragment,{children:[r.jsxs(_,{label:"Manage lifeboats",dangerous:{gap:"var(--gap-2)",flexWrap:"wrap"},children:[r.jsx(g.Positive,{onClick:l,children:"Create Draft"}),r.jsx(g.Positive,{onClick:o,children:"Update Draft"}),r.jsx(g.Negative,{isIcon:!0,onClick:j,children:"Clear Draft"}),r.jsx(g.Negative,{isIcon:!0,onClick:I,children:"Clear All"}),r.jsx(g.Positive,{onClick:a,disabled:u!==void 0,children:u===void 0?"Set critical info":r.jsx(k.Info,{size:28})})]}),r.jsx("br",{}),r.jsxs(J,{gridTemplateColumns:{xs:"1fr",md:"1fr 1fr"},gap:{xs:"var(--gap-4)"},children:[x!=null&&r.jsx(r.Fragment,{children:r.jsx(F,{mood:"positive",fitContent:!0,children:r.jsx(O,{children:x.title})})}),u!==void 0&&r.jsxs(r.Fragment,{children:[r.jsx("br",{}),r.jsx(F,{fitContent:!0,children:r.jsx(O,{children:typeof u?.value=="string"?u.value:""})})]})]}),c&&r.jsxs(r.Fragment,{children:[r.jsx("br",{}),r.jsx(k.LoadingBar,{})]}),r.jsx("br",{})]})}export{we as default};
