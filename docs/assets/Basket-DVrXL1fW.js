import{f as N,r as n,n as M,j as t,F as g,l as V,B as Q,G as B,I as D,a as T,d as O}from"./index-D9xIr4Uz.js";import{u as $}from"./useQuery-DHCimQGH.js";function W(e,a){const s=N(),h=s.getQueryCache();return n.useSyncExternalStore(n.useCallback(C=>h.subscribe(M.batchCalls(C)),[h]),()=>s.isFetching(e),()=>s.isFetching(e))}function L(e){const a=new Set,s=[];for(const h of e)a.has(h)||(a.add(h),s.push(h));return s}function P(e,a){switch(a.type){case"ADD":return{selected:L([...e.selected,...a.ids])};case"REMOVE":return{selected:e.selected.filter(s=>!a.ids.includes(s))};case"TOGGLE":return e.selected.includes(a.id)?{selected:e.selected.filter(s=>s!==a.id)}:{selected:[...e.selected,a.id]};case"SET":return{selected:L(a.ids)};case"CLEAR":return{selected:[]};default:return e}}function U(e){const a=n.useRef(new Map),s=n.useRef(new Map),[h,C]=n.useState(0);n.useMemo(()=>{},[]);const[l,u]=n.useReducer(P,{selected:[]}),j=n.useRef(new Set);n.useEffect(()=>{j.current=new Set(l.selected)},[l.selected]);function m(r,p){const f=s.current,E=a.current,F=f.get(r)??[];for(const S of p)E.set(S.id,{group:r,item:S}),F.includes(S.id)||F.push(S.id);f.set(r,F),C(S=>S+1)}const x=n.useCallback((r,p)=>{m(r,p)},[]),w=n.useCallback(r=>a.current.get(r)?.item,[]),A=n.useCallback(()=>Array.from(s.current.keys()),[]),I=n.useCallback(r=>(s.current.get(r)??[]).map(f=>a.current.get(f).item),[]),v=n.useCallback(r=>u({type:"ADD",ids:r}),[]),R=n.useCallback(r=>u({type:"REMOVE",ids:r}),[]),c=n.useCallback(r=>u({type:"TOGGLE",id:r}),[]),i=n.useCallback(r=>u({type:"SET",ids:r}),[]),o=n.useCallback(()=>u({type:"CLEAR"}),[]),d=n.useMemo(()=>l.selected.map(r=>a.current.get(r)?.item).filter(Boolean),[l.selected,h]),b=n.useMemo(()=>{const r=new Map;for(const p of l.selected){const f=a.current.get(p);if(!f)continue;const E=r.get(f.group)??[];E.push(f.item),r.set(f.group,E)}return r},[l.selected,h]),k=n.useMemo(()=>{const r={};for(const[p,f]of s.current.entries())r[p]=0;for(const p of l.selected){const f=a.current.get(p);f&&(r[f.group]=(r[f.group]||0)+1)}return r},[l.selected,h]),z=n.useCallback(r=>l.selected.map(p=>a.current.get(p)).filter(Boolean).map(p=>r?r(p):{id:p.item.id,group:p.group}),[l.selected]),y=n.useCallback(r=>j.current.has(r),[]);return{api:{add:v,remove:R,toggle:c,set:i,clear:o,addOptions:x},views:{flattened:d,grouped:b,countsByGroup:k,selectedIds:l.selected},helpers:{getItem:w,availableGroups:A,availableItemsInGroup:I,isSelected:y,export:z}}}function X({queryKey:e,exactMatch:a=!1}){const s=N(),C=W({queryKey:e,exact:a})>0,l=n.useCallback(async(o={})=>{await s.invalidateQueries({queryKey:e,exact:a,refetchType:o.refetchActive===!1&&o.refetchInactive===!1?"none":o.refetchInactive?"all":"active"})},[s,e,a]),u=n.useCallback(async()=>{await s.invalidateQueries()},[s]),j=n.useCallback(o=>{s.setQueryData(e,o)},[s,e]),m=n.useCallback(o=>{s.setQueryData(e,d=>Array.isArray(d)?[...d,o]:d)},[s,e]),x=n.useCallback(o=>{s.setQueryData(e,d=>Array.isArray(d)?[o,...d]:d)},[s,e]),w=n.useCallback(o=>{s.setQueryData(e,d=>Array.isArray(d)?d.filter((b,k)=>!o(b,k)):d)},[s,e]),A=n.useCallback((o,d)=>{s.setQueryData(e,b=>Array.isArray(b)?b.map((k,z)=>o(k,z)?d(k):k):b)},[s,e]),I=n.useCallback(()=>s.getQueryData(e),[s,e]),v=n.useCallback(()=>{s.removeQueries({queryKey:e,exact:a})},[s,e,a]),R=n.useCallback(async()=>{await s.cancelQueries({queryKey:e,exact:a})},[s,e,a]),c=n.useCallback(async(o={})=>{await s.refetchQueries({queryKey:e,exact:a,type:o.force?"all":"active"})},[s,e,a]),i=n.useCallback(()=>s.getQueryState(e),[s,e]);return n.useMemo(()=>({isFetching:C,invalidate:l,invalidateAll:u,setData:j,appendData:m,prependData:x,removeDataItem:w,updateDataItem:A,getData:I,removeQueries:v,cancelQueries:R,refetch:c,getQueryState:i}),[C,l,u,j,m,x,w,A,I,v,R,c,i])}const H=(e,a=`${e}s`)=>s=>Math.abs(s)===1?e:a,G=["people","planets","starships"];function Y(){const[e,a]=n.useState("people"),[s,h]=n.useState(null),C=U(),{api:l,views:u,helpers:j}=C,{data:m=[],isLoading:x,error:w}=$({queryKey:["swapi",e],queryFn:async()=>{const c=await fetch(`https://swapi.dev/api/${e}/`);if(!c.ok)throw new Error("Failed to fetch");return((await c.json()).results||[]).map((o,d)=>({...o,name:o?.name??"-",isFavorite:!1,id:`${e}-${d}`}))}});n.useEffect(()=>{x||m===void 0||s===e||(l.addOptions(e,m),h(e))},[m,x,l,e,s]);const A=c=>{R(c.id),l.toggle(c.id)},I=H("selection"),v=X({queryKey:["swapi",e]}),R=c=>{console.log({id:c,characterHelpers:v}),v.updateDataItem(i=>i.id===c,i=>({...i,isFavorite:!i.isFavorite}))};return t.jsxs(t.Fragment,{children:[t.jsxs(g.Bold,{size:"lg",children:["Load Options"," ",t.jsx(g.Bold,{size:"lg",component:"span",dangerousColor:"var(--positive)",children:G.length})]}),t.jsx("br",{}),t.jsx(V,{label:"pick from resources",dangerous:{gap:"var(--gap-1)"},children:G.map(c=>t.jsx(Q,{onClick:()=>a(c),isActive:e===c,children:c.charAt(0).toUpperCase()+c.slice(1)},c))}),t.jsx("br",{}),t.jsxs(g.Bold,{size:"lg",children:["Add options"," ",t.jsx(g.Bold,{size:"lg",component:"span",dangerousColor:"var(--positive)",children:m.length})]}),t.jsx("br",{}),t.jsxs(B.Row,{flexWrap:"wrap",gap:"var(--gap-3)",dangerous:{padding:"var(--gap-3)"},className:"theme-transparent",children:[x&&t.jsx(D.LoadingBar,{}),w&&t.jsx(T,{mood:"negative",children:t.jsx(g,{children:" Error loading items"})}),m.length===0&&!x&&t.jsx(T,{children:t.jsx(g,{children:" No items found"})}),m.map((c,i)=>{const o=j.isSelected(c.id)||c.isFavorite;return t.jsxs(B.Row,{className:O(o&&"positive","theme-transparent"),dangerous:{padding:"0 0 0 var(--gap-1)",backgroundColor:i%2?"#aaa":"#ccc",alignItems:"center"},children:[t.jsx(g,{children:c?.name??""}),t.jsx(Q,{onClick:()=>A(c),isActive:o,children:o?t.jsx(D.X,{size:22}):t.jsx(D.Add,{size:22})})]},c.id)})]}),t.jsx("br",{}),t.jsxs(g.Bold,{size:"lg",children:[I(u.selectedIds.length)," ",t.jsxs(g.Bold,{size:"lg",component:"span",dangerousColor:"var(--positive)",children:[u.selectedIds.length," "]})]}),t.jsx("br",{}),t.jsx(B.Row,{flexWrap:"wrap",gap:"var(--gap-3)",children:u.selectedIds.length===0?t.jsx(g,{children:"Add items to your basket"}):u.flattened.map((c,i)=>t.jsxs(B.Row,{className:O("theme-transparent"),dangerous:{padding:"0 0 0 var(--gap-1)",backgroundColor:i%2?"#aaa":"#ccc",alignItems:"center"},children:[t.jsxs(g,{clamp:1,children:[" ",c.name??""]}),t.jsx(Q,{onClick:()=>l.remove([c.id]),children:t.jsx(D.X,{size:22})})]},c.id))}),t.jsx("br",{}),t.jsxs(g.Bold,{size:"lg",children:["Selections grouped",t.jsx(g.Bold,{size:"lg",component:"span",dangerousColor:"var(--positive)",children:G.length})]}),t.jsx("br",{}),t.jsx(B.Col,{dangerous:{maxWidth:"300px"},children:Object.entries(u.countsByGroup).map(([c,i],o)=>i>0?t.jsxs(B.Row,{className:O("theme-transparent"),dangerous:{padding:"var(--px)",backgroundColor:o%2?"#aaa":"#ccc",alignItems:"center"},children:[t.jsx(g,{children:c}),t.jsxs(g.Bold,{children:[i,"/",u.selectedIds.length]})]},c):null)}),t.jsx("br",{}),u.selectedIds.length>0&&t.jsx(Q,{onClick:()=>l.clear(),children:"Clear All"}),t.jsx("br",{})]})}export{Y as default};
